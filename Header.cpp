#include "Header.hpp"

stringMap mimeInit()
{
	stringMap mime;
	mime["123"] = "application/vnd.lotus-1-2-3";
	mime["3ds"] = "image/x-3ds";
	mime["669"] = "audio/x-mod";
	mime["a"] = "application/x-archive";
	mime["abw"] = "application/x-abiword";
	mime["ac3"] = "audio/ac3";
	mime["adb"] = "text/x-adasrc";
	mime["ads"] = "text/x-adasrc";
	mime["afm"] = "application/x-font-afm";
	mime["ag"] = "image/x-applix-graphics";
	mime["ai"] = "application/illustrator";
	mime["aif"] = "audio/x-aiff";
	mime["aifc"] = "audio/x-aiff";
	mime["aiff"] = "audio/x-aiff";
	mime["al"] = "application/x-perl";
	mime["arj"] = "application/x-arj";
	mime["as"] = "application/x-applix-spreadsheet";
	mime["asc"] = "text/plain";
	mime["asf"] = "video/x-ms-asf";
	mime["asp"] = "application/x-asp";
	mime["asx"] = "video/x-ms-asf";
	mime["au"] = "audio/basic";
	mime["avi"] = "video/x-msvideo";
	mime["aw"] = "application/x-applix-word";
	mime["bak"] = "application/x-trash";
	mime["bcpio"] = "application/x-bcpio";
	mime["bdf"] = "application/x-font-bdf";
	mime["bib"] = "text/x-bibtex";
	mime["bin"] = "application/octet-stream";
	mime["blend"] = "application/x-blender";
	mime["blender"] = "application/x-blender";
	mime["bmp"] = "image/bmp";
	mime["bz"] = "application/x-bzip";
	mime["bz2"] = "application/x-bzip";
	mime["c"] = "text/x-csrc";
	mime["c++"] = "text/x-c++src";
	mime["cc"] = "text/x-c++src";
	mime["cdf"] = "application/x-netcdf";
	mime["cdr"] = "application/vnd.corel-draw";
	mime["cer"] = "application/x-x509-ca-cert";
	mime["cert"] = "application/x-x509-ca-cert";
	mime["cgi"] = "application/x-cgi";
	mime["cgm"] = "image/cgm";
	mime["chrt"] = "application/x-kchart";
	mime["class"] = "application/x-java";
	mime["cls"] = "text/x-tex";
	mime["cpio"] = "application/x-cpio";
	mime["cpp"] = "text/x-c++src";
	mime["crt"] = "application/x-x509-ca-cert";
	mime["cs"] = "text/x-csharp";
	mime["csh"] = "application/x-shellscript";
	mime["css"] = "text/css";
	mime["cssl"] = "text/css";
	mime["csv"] = "text/x-comma-separated-values";
	mime["cur"] = "image/x-win-bitmap";
	mime["cxx"] = "text/x-c++src";
	mime["dat"] = "video/mpeg";
	mime["dbf"] = "application/x-dbase";
	mime["dc"] = "application/x-dc-rom";
	mime["dcl"] = "text/x-dcl";
	mime["dcm"] = "image/x-dcm";
	mime["deb"] = "application/x-deb";
	mime["der"] = "application/x-x509-ca-cert";
	mime["desktop"] = "application/x-desktop";
	mime["dia"] = "application/x-dia-diagram";
	mime["diff"] = "text/x-patch";
	mime["djv"] = "image/vnd.djvu";
	mime["djvu"] = "image/vnd.djvu";
	mime["doc"] = "application/vnd.ms-word";
	mime["dsl"] = "text/x-dsl";
	mime["dtd"] = "text/x-dtd";
	mime["dvi"] = "application/x-dvi";
	mime["dwg"] = "image/vnd.dwg";
	mime["dxf"] = "image/vnd.dxf";
	mime["egon"] = "application/x-egon";
	mime["el"] = "text/x-emacs-lisp";
	mime["eps"] = "image/x-eps";
	mime["epsf"] = "image/x-eps";
	mime["epsi"] = "image/x-eps";
	mime["etheme"] = "application/x-e-theme";
	mime["etx"] = "text/x-setext";
	mime["exe"] = "application/x-ms-dos-executable";
	mime["ez"] = "application/andrew-inset";
	mime["f"] = "text/x-fortran";
	mime["fig"] = "image/x-xfig";
	mime["fits"] = "image/x-fits";
	mime["flac"] = "audio/x-flac";
	mime["flc"] = "video/x-flic";
	mime["fli"] = "video/x-flic";
	mime["flw"] = "application/x-kivio";
	mime["fo"] = "text/x-xslfo";
	mime["g3"] = "image/fax-g3";
	mime["gb"] = "application/x-gameboy-rom";
	mime["gcrd"] = "text/x-vcard";
	mime["gen"] = "application/x-genesis-rom";
	mime["gg"] = "application/x-sms-rom";
	mime["gif"] = "image/gif";
	mime["glade"] = "application/x-glade";
	mime["gmo"] = "application/x-gettext-translation";
	mime["gnc"] = "application/x-gnucash";
	mime["gnucash"] = "application/x-gnucash";
	mime["gnumeric"] = "application/x-gnumeric";
	mime["gra"] = "application/x-graphite";
	mime["gsf"] = "application/x-font-type1";
	mime["gtar"] = "application/x-gtar";
	mime["gz"] = "application/x-gzip";
	mime["h"] = "text/x-chdr";
	mime["h++"] = "text/x-chdr";
	mime["hdf"] = "application/x-hdf";
	mime["hh"] = "text/x-c++hdr";
	mime["hp"] = "text/x-chdr";
	mime["hpgl"] = "application/vnd.hp-hpgl";
	mime["hs"] = "text/x-haskell";
	mime["htm"] = "text/html";
	mime["html"] = "text/html";
	mime["icb"] = "image/x-icb";
	mime["ico"] = "image/x-ico";
	mime["ics"] = "text/calendar";
	mime["idl"] = "text/x-idl";
	mime["ief"] = "image/ief";
	mime["iff"] = "image/x-iff";
	mime["ilbm"] = "image/x-ilbm";
	mime["iso"] = "application/x-cd-image";
	mime["it"] = "audio/x-it";
	mime["jar"] = "application/x-jar";
	mime["java"] = "text/x-java";
	mime["jng"] = "image/x-jng";
	mime["jp2"] = "image/jpeg2000";
	mime["jpe"] = "image/jpeg";
	mime["jpeg"] = "image/jpeg";
	mime["jpg"] = "image/jpeg";
	mime["jpr"] = "application/x-jbuilder-project";
	mime["jpx"] = "application/x-jbuilder-project";
	mime["js"] = "application/x-javascript";
	mime["karbon"] = "application/x-karbon";
	mime["kdelnk"] = "application/x-desktop";
	mime["kfo"] = "application/x-kformula";
	mime["kil"] = "application/x-killustrator";
	mime["kon"] = "application/x-kontour";
	mime["kpm"] = "application/x-kpovmodeler";
	mime["kpr"] = "application/x-kpresenter";
	mime["kpt"] = "application/x-kpresenter";
	mime["kra"] = "application/x-krita";
	mime["ksp"] = "application/x-kspread";
	mime["kud"] = "application/x-kugar";
	mime["kwd"] = "application/x-kword";
	mime["kwt"] = "application/x-kword";
	mime["la"] = "application/x-shared-library-la";
	mime["lha"] = "application/x-lha";
	mime["lhs"] = "text/x-literate-haskell";
	mime["lhz"] = "application/x-lhz";
	mime["log"] = "text/x-log";
	mime["ltx"] = "text/x-tex";
	mime["lwo"] = "image/x-lwo";
	mime["lwob"] = "image/x-lwo";
	mime["lws"] = "image/x-lws";
	mime["lyx"] = "application/x-lyx";
	mime["lzh"] = "application/x-lha";
	mime["lzo"] = "application/x-lzop";
	mime["m"] = "text/x-objcsrc";
	mime["m15"] = "audio/x-mod";
	mime["m3u"] = "audio/x-mpegurl";
	mime["man"] = "application/x-troff-man";
	mime["md"] = "application/x-genesis-rom";
	mime["me"] = "text/x-troff-me";
	mime["mgp"] = "application/x-magicpoint";
	mime["mid"] = "audio/midi";
	mime["midi"] = "audio/midi";
	mime["mif"] = "application/x-mif";
	mime["mkv"] = "application/x-matroska";
	mime["mm"] = "text/x-troff-mm";
	mime["mml"] = "text/mathml";
	mime["mng"] = "video/x-mng";
	mime["moc"] = "text/x-moc";
	mime["mod"] = "audio/x-mod";
	mime["moov"] = "video/quicktime";
	mime["mov"] = "video/quicktime";
	mime["movie"] = "video/x-sgi-movie";
	mime["mp2"] = "video/mpeg";
	mime["mp3"] = "audio/x-mp3";
	mime["mpe"] = "video/mpeg";
	mime["mpeg"] = "video/mpeg";
	mime["mpg"] = "video/mpeg";
	mime["ms"] = "text/x-troff-ms";
	mime["msod"] = "image/x-msod";
	mime["msx"] = "application/x-msx-rom";
	mime["mtm"] = "audio/x-mod";
	mime["n64"] = "application/x-n64-rom";
	mime["nc"] = "application/x-netcdf";
	mime["nes"] = "application/x-nes-rom";
	mime["nsv"] = "video/x-nsv";
	mime["o"] = "application/x-object";
	mime["obj"] = "application/x-tgif";
	mime["oda"] = "application/oda";
	mime["ogg"] = "application/ogg";
	mime["old"] = "application/x-trash";
	mime["oleo"] = "application/x-oleo";
	mime["p"] = "text/x-pascal";
	mime["p12"] = "application/x-pkcs12";
	mime["p7s"] = "application/pkcs7-signature";
	mime["pas"] = "text/x-pascal";
	mime["patch"] = "text/x-patch";
	mime["pbm"] = "image/x-portable-bitmap";
	mime["pcd"] = "image/x-photo-cd";
	mime["pcf"] = "application/x-font-pcf";
	mime["pcl"] = "application/vnd.hp-pcl";
	mime["pdb"] = "application/vnd.palm";
	mime["pdf"] = "application/pdf";
	mime["pem"] = "application/x-x509-ca-cert";
	mime["perl"] = "application/x-perl";
	mime["pfa"] = "application/x-font-type1";
	mime["pfb"] = "application/x-font-type1";
	mime["pfx"] = "application/x-pkcs12";
	mime["pgm"] = "image/x-portable-graymap";
	mime["pgn"] = "application/x-chess-pgn";
	mime["pgp"] = "application/pgp";
	mime["php"] = "application/x-php";
	mime["php3"] = "application/x-php";
	mime["php4"] = "application/x-php";
	mime["pict"] = "image/x-pict";
	mime["pict1"] = "image/x-pict";
	mime["pict2"] = "image/x-pict";
	mime["pl"] = "application/x-perl";
	mime["pls"] = "audio/x-scpls";
	mime["pm"] = "application/x-perl";
	mime["png"] = "image/png";
	mime["pnm"] = "image/x-portable-anymap";
	mime["po"] = "text/x-gettext-translation";
	mime["pot"] = "text/x-gettext-translation-template";
	mime["ppm"] = "image/x-portable-pixmap";
	mime["pps"] = "application/vnd.ms-powerpoint";
	mime["ppt"] = "application/vnd.ms-powerpoint";
	mime["ppz"] = "application/vnd.ms-powerpoint";
	mime["ps"] = "application/postscript";
	mime["psd"] = "image/x-psd";
	mime["psf"] = "application/x-font-linux-psf";
	mime["psid"] = "audio/prs.sid";
	mime["pw"] = "application/x-pw";
	mime["py"] = "application/x-python";
	mime["pyc"] = "application/x-python-bytecode";
	mime["pyo"] = "application/x-python-bytecode";
	mime["qif"] = "application/x-qw";
	mime["qt"] = "video/quicktime";
	mime["qtvr"] = "video/quicktime";
	mime["ra"] = "audio/x-pn-realaudio";
	mime["ram"] = "audio/x-pn-realaudio";
	mime["rar"] = "application/x-rar";
	mime["ras"] = "image/x-cmu-raster";
	mime["rdf"] = "text/rdf";
	mime["rej"] = "application/x-reject";
	mime["rgb"] = "image/x-rgb";
	mime["rle"] = "image/rle";
	mime["rm"] = "audio/x-pn-realaudio";
	mime["roff"] = "application/x-troff";
	mime["rpm"] = "application/x-rpm";
	mime["rss"] = "text/rss";
	mime["rtf"] = "application/rtf";
	mime["rtx"] = "text/richtext";
	mime["s3m"] = "audio/x-s3m";
	mime["sam"] = "application/x-amipro";
	mime["scm"] = "text/x-scheme";
	mime["sda"] = "application/vnd.stardivision.draw";
	mime["sdc"] = "application/vnd.stardivision.calc";
	mime["sdd"] = "application/vnd.stardivision.impress";
	mime["sdp"] = "application/vnd.stardivision.impress";
	mime["sds"] = "application/vnd.stardivision.chart";
	mime["sdw"] = "application/vnd.stardivision.writer";
	mime["sgi"] = "image/x-sgi";
	mime["sgl"] = "application/vnd.stardivision.writer";
	mime["sgm"] = "text/sgml";
	mime["sgml"] = "text/sgml";
	mime["sh"] = "application/x-shellscript";
	mime["shar"] = "application/x-shar";
	mime["siag"] = "application/x-siag";
	mime["sid"] = "audio/prs.sid";
	mime["sik"] = "application/x-trash";
	mime["slk"] = "text/spreadsheet";
	mime["smd"] = "application/vnd.stardivision.mail";
	mime["smf"] = "application/vnd.stardivision.math";
	mime["smi"] = "application/smil";
	mime["smil"] = "application/smil";
	mime["sml"] = "application/smil";
	mime["sms"] = "application/x-sms-rom";
	mime["snd"] = "audio/basic";
	mime["so"] = "application/x-sharedlib";
	mime["spd"] = "application/x-font-speedo";
	mime["sql"] = "text/x-sql";
	mime["src"] = "application/x-wais-source";
	mime["stc"] = "application/vnd.sun.xml.calc.template";
	mime["std"] = "application/vnd.sun.xml.draw.template";
	mime["sti"] = "application/vnd.sun.xml.impress.template";
	mime["stm"] = "audio/x-stm";
	mime["stw"] = "application/vnd.sun.xml.writer.template";
	mime["sty"] = "text/x-tex";
	mime["sun"] = "image/x-sun-raster";
	mime["sv4cpio"] = "application/x-sv4cpio";
	mime["sv4crc"] = "application/x-sv4crc";
	mime["svg"] = "image/svg+xml";
	mime["swf"] = "application/x-shockwave-flash";
	mime["sxc"] = "application/vnd.sun.xml.calc";
	mime["sxd"] = "application/vnd.sun.xml.draw";
	mime["sxg"] = "application/vnd.sun.xml.writer.global";
	mime["sxi"] = "application/vnd.sun.xml.impress";
	mime["sxm"] = "application/vnd.sun.xml.math";
	mime["sxw"] = "application/vnd.sun.xml.writer";
	mime["sylk"] = "text/spreadsheet";
	mime["t"] = "application/x-troff";
	mime["tar"] = "application/x-tar";
	mime["tcl"] = "text/x-tcl";
	mime["tcpalette"] = "application/x-terminal-color-palette";
	mime["tex"] = "text/x-tex";
	mime["texi"] = "text/x-texinfo";
	mime["texinfo"] = "text/x-texinfo";
	mime["tga"] = "image/x-tga";
	mime["tgz"] = "application/x-compressed-tar";
	mime["theme"] = "application/x-theme";
	mime["tif"] = "image/tiff";
	mime["tiff"] = "image/tiff";
	mime["tk"] = "text/x-tcl";
	mime["torrent"] = "application/x-bittorrent";
	mime["tr"] = "application/x-troff";
	mime["ts"] = "application/x-linguist";
	mime["tsv"] = "text/tab-separated-values";
	mime["ttf"] = "application/x-font-ttf";
	mime["txt"] = "text/plain";
	mime["tzo"] = "application/x-tzo";
	mime["ui"] = "application/x-designer";
	mime["uil"] = "text/x-uil";
	mime["ult"] = "audio/x-mod";
	mime["uni"] = "audio/x-mod";
	mime["uri"] = "text/x-uri";
	mime["url"] = "text/x-uri";
	mime["ustar"] = "application/x-ustar";
	mime["vcf"] = "text/x-vcalendar";
	mime["vcs"] = "text/x-vcalendar";
	mime["vct"] = "text/x-vcard";
	mime["vob"] = "video/mpeg";
	mime["voc"] = "audio/x-voc";
	mime["vor"] = "application/vnd.stardivision.writer";
	mime["vpp"] = "application/x-extension-vpp";
	mime["wav"] = "audio/x-wav";
	mime["wb1"] = "application/x-quattropro";
	mime["wb2"] = "application/x-quattropro";
	mime["wb3"] = "application/x-quattropro";
	mime["wk1"] = "application/vnd.lotus-1-2-3";
	mime["wk3"] = "application/vnd.lotus-1-2-3";
	mime["wk4"] = "application/vnd.lotus-1-2-3";
	mime["wks"] = "application/vnd.lotus-1-2-3";
	mime["wmf"] = "image/x-wmf";
	mime["wml"] = "text/vnd.wap.wml";
	mime["wmv"] = "video/x-ms-wmv";
	mime["wpd"] = "application/vnd.wordperfect";
	mime["wpg"] = "application/x-wpg";
	mime["wri"] = "application/x-mswrite";
	mime["wrl"] = "model/vrml";
	mime["xac"] = "application/x-gnucash";
	mime["xbel"] = "application/x-xbel";
	mime["xbm"] = "image/x-xbitmap";
	mime["xcf"] = "image/x-xcf";
	mime["xhtml"] = "application/xhtml+xml";
	mime["xi"] = "audio/x-xi";
	mime["xla"] = "application/vnd.ms-excel";
	mime["xlc"] = "application/vnd.ms-excel";
	mime["xld"] = "application/vnd.ms-excel";
	mime["xll"] = "application/vnd.ms-excel";
	mime["xlm"] = "application/vnd.ms-excel";
	mime["xls"] = "application/vnd.ms-excel";
	mime["xlt"] = "application/vnd.ms-excel";
	mime["xlw"] = "application/vnd.ms-excel";
	mime["xm"] = "audio/x-xm";
	mime["xmi"] = "text/x-xmi";
	mime["xml"] = "text/xml";
	mime["xpm"] = "image/x-xpixmap";
	mime["xsl"] = "text/x-xslt";
	mime["xslfo"] = "text/x-xslfo";
	mime["xslt"] = "text/x-xslt";
	mime["xwd"] = "image/x-xwindowdump";
	mime["z"] = "application/x-compress";
	mime["zabw"] = "application/x-abiword";
	mime["zip"] = "application/zip";
	mime["zoo"] = "application/x-zoo";
	return mime;
}
stringMap mime = mimeInit();

Header::Header(std::string const &path, std::string const &root, int const statusCode)
	: _path(path),
	  _root(root),
	  _statusCode(statusCode) {}

Header::Header(RequestData const &data, int const statusCode)
	: _path(data.uri.script_name),
	  _root(data.location->root),
	  _extension(data.uri.extension),
	  _request_uri(data.uri.request_uri),
	  _server_name(data.serv->serverName),
	  _location(data.location),
	  _statusCode(statusCode) {}

Header::~Header(){ }

void	Header::headersToString(stringMap const &headersMap, std::string &output)
{
	int	status_to_send = _statusCode == 0 ? 200 : _statusCode;
	std::string statusCodeStr = size2Dec(status_to_send);
	output += "HTTP/1.1 " + statusCodeStr + " " + sc[status_to_send] + CRLF;
	for (constMapIter it = headersMap.begin(); it != headersMap.end(); ++it)
		output += (it->first) + ": " + (it->second) + CRLF;
	output += CRLF;
}

void	Header::createGeneralHeaders(stringMap &headersMap)
{
	char			buf1[100];
	struct timeval	tv;
	struct tm		*tm1;

	gettimeofday(&tv, NULL);
	tm1 = gmtime(&tv.tv_sec);
	strftime(buf1, 100, "%a, %d %b %Y %H:%M:%S GMT", tm1);
	std::string date = std::string(buf1);
	if (_server_name.empty())
		_server_name = "Bshabillum";
	headersMap.insert(std::pair<std::string, std::string>("Server", _server_name + "/1.0.7"));
	headersMap.insert(std::pair<std::string, std::string>("Date", date));
}

void	Header::addContentLanguageHeader(stringMap &headersMap)
{
	headersMap.insert(std::pair<std::string, std::string>("Content-Language", "en-US"));
}

void	Header::addContentLengthHeader(stringMap &headersMap, std::string const & body)
{
	size_t bodySize;
	struct stat stat_buf;

	if (body.length())
		bodySize = body.length();
	else {
		int rc = stat(_path.c_str(), &stat_buf);
		if (rc == -1 || S_ISDIR(stat_buf.st_mode))
			return ;
		bodySize = stat_buf.st_size;
	}
	std::string contentLength = size2Dec(bodySize);
	headersMap.insert(std::pair<std::string, std::string>("Content-Length", contentLength));
}

void	Header::addContentLocationHeader(stringMap &_headersMap)
{
	if (_statusCode >= 400)
		return ;
	_headersMap.insert(std::pair<std::string, std::string>("Content-Location", _request_uri));
}

void  Header::addContentTypeHeader(stringMap &_headersMap)
{
	if (_statusCode >= 400)
		return ;

	constMapIter it = mime.begin();
	while (it != mime.end()){
		if (it->first == _extension){
			_headersMap.insert(std::pair<std::string, std::string>("Content-Type", it->second));
			break ;
		}
		it++;
	}
}

void	Header::addLastModifiedHeader(stringMap &headersMap)
{
	if (_statusCode >= 400)
		return ;
	std::string lastModified = getLastModifiedTime(_path);
	if (lastModified != "")
		headersMap.insert(std::pair<std::string, std::string>("Last-Modified", lastModified));
}

void	Header::addAllowHeader(stringMap &_headersMap)
{
	std::string allowedMethods;
	if ((*_location).getAvailable)
		allowedMethods += "GET, ";
	if ((*_location).headAvailable)
		allowedMethods += "HEAD, ";
	if ((*_location).postAvailable)
		allowedMethods += "POST, ";
	if ((*_location).putAvailable)
		allowedMethods += "PUT, ";
	if ((*_location).optionsAvailable)
		allowedMethods += "OPTIONS, ";
	if ((*_location).deleteAvailable)
		allowedMethods += "DELETE";
	if (!allowedMethods.empty() && allowedMethods.at(allowedMethods.length() - 1) == ' ')
		allowedMethods.resize(allowedMethods.length() - 2);
	_headersMap.insert(std::pair<std::string, std::string>("Allow", allowedMethods));
}

void  Header::addLocationHeader(stringMap &_headersMap)
{
	if (_statusCode >= 300 && _statusCode < 400)
		_headersMap.insert(std::pair<std::string, std::string>("Location", _root));
}

void	Header::addRetryAfterHeader(stringMap &_headersMap)
{
	if (_statusCode == 503 || _statusCode == 429 || _statusCode == 301)
		_headersMap.insert(std::pair<std::string, std::string>("Retry-After", "120"));
}

void	Header::addTransferEncodingHeader(stringMap &_headersMap, stringMap const &_headersMapRequest)
{
	constMapIter it = _headersMapRequest.find("transfer-encoding");
	if (it != _headersMapRequest.end())
	{
		_headersMap.insert(std::pair<std::string, std::string>("Transfer-Encoding", it->second));
	}
}

void	Header::addAuthenticateHeader(stringMap &_headersMap)
{
	if (_statusCode == 401)
		_headersMap.insert(std::pair<std::string, std::string>("WWW-Authenticate", \
		"Basic realm=\"Access to the staging site\", charset=\"UTF-8\""));
}
